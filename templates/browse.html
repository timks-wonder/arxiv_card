<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>arXiv Cards</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .paper-card {
            margin: 1rem auto;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .paper-card:hover {
            transform: translateY(-3px);
        }
        .action-buttons {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <nav class="navbar navbar-light bg-light mb-4 rounded">
            <div class="container-fluid">
                <span class="navbar-brand">arXiv Cards</span>
                <div class="d-flex">
                    <span class="navbar-text me-3">
                        æ¬¢è¿ï¼Œ<span id="usernameDisplay">{{ username }}</span>
                        <!-- æ–°å¢éšè—çš„ç”¨æˆ·IDå­—æ®µ -->
                        <span id="userId" style="display:none">{{ session.user_id }}</span>
                    </span>
                    <button class="btn btn-outline-secondary" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
        </nav>
        
        <h3 class="mb-4">è®ºæ–‡æ¨è</h3>
        <div id="paperContainer">
            <!-- åŠ¨æ€åŠ è½½è®ºæ–‡å¡ç‰‡ -->
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–åŠ è½½è®ºæ–‡
        window.onload = function() {
            // ç›´æ¥ä½¿ç”¨æ¨¡æ¿å˜é‡ä¸­çš„ç”¨æˆ·åï¼Œæ— éœ€ä»sessionStorageè·å–
            console.log('username:', document.getElementById('usernameDisplay').textContent);
            loadNewPapers(3);
        };

        // é€€å‡ºç™»å½•åŠŸèƒ½
        function logout() {
            fetch('/auth/logout', { method: 'POST' })
                .then(() => window.location.href = '/auth/login');
        }

        // åŠ è½½æ–°è®ºæ–‡
        // ä¿®æ”¹åçš„åŠ è½½æ–°è®ºæ–‡å‡½æ•°
        async function loadNewPapers(count) {
            try {
                // ä»éšè—å­—æ®µè·å–ç”¨æˆ·ID
                const user_id = parseInt(document.getElementById('userId').textContent);
                const response = await fetch(`http://localhost:5001/api/papers?user_id=${user_id}`);
                const papers = await response.json();
                
                // ç§»é™¤åŸæœ‰çš„IDæ£€æŸ¥é€»è¾‘ï¼Œç›´æ¥åˆ›å»ºå¡ç‰‡
                for (const paper of papers.slice(0, count)) {
                    createPaperCard(paper);
                    await fetch(`http://localhost:5001/api/viewed?user_id=${user_id}&paper_id=${paper.id}`)
                }
        
                // ä¿æŒæ˜¾ç¤ºæ•°é‡é€»è¾‘ä¿æŒä¸å˜
                if (document.querySelectorAll('.paper-card').length < count) {
                    await loadNewPapers(1);
                }
            } catch (error) {
                console.error('è·å–è®ºæ–‡å¤±è´¥:', error);
            }
        }

        // åˆ›å»ºè®ºæ–‡å¡ç‰‡
        function createPaperCard(paper) {
            const card = document.createElement('div');
            card.className = 'paper-card bg-white';
            card.innerHTML = `
                <h5><a href="${paper.url}" target="_blank">${paper.title}</a></h5>
                <div class="text-muted mb-2">ä½œè€…ï¼š${paper.authors}</div>
                <div class="summary-container">
                    <p class="text-secondary summary-content">æ‘˜è¦ï¼š${paper.summary}</p>
                    <button class="btn btn-link btn-sm p-0" onclick="toggleSummary(this)">å±•å¼€</button>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-outline-danger" 
                            title="dislike"
                            data-bs-toggle="tooltip"
                            onclick="handleAction(this, 'dislike', '${paper.summary_embeddings}', '${paper.id}')">ğŸ’”</button>
                    <button class="btn btn-primary" 
                            title="like"
                            data-bs-toggle="tooltip"
                            onclick="handleAction(this, 'like', '${paper.summary_embeddings}', '${paper.id}')">â¤ï¸</button>
                </div>
            `;
            document.getElementById('paperContainer').appendChild(card);
        }

        // å¤„ç†ç”¨æˆ·æ“ä½œ
        async function handleAction(button, actionType, summary_embeddings, paper_id) {
            const card = button.closest('.paper-card');
            card.style.opacity = '0.5';
            
            try {
                // ä»éšè—å­—æ®µè·å–ç”¨æˆ·ID
                const user_id = parseInt(document.getElementById('userId').textContent);
                await fetch(`http://localhost:5001/api/${actionType}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        user_id: user_id,
                        paper_id: paper_id, 
                        summary_embeddings: summary_embeddings
                    })
                });
                
                card.remove();
                loadNewPapers(1);
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                card.style.opacity = '1';
            }
        }
    </script>
</body>
</html>

<style>
    .summary-container {
        position: relative;
    }
    .summary-content {
        display: -webkit-box;
        -webkit-line-clamp: 2; /* è¿™é‡Œæ§åˆ¶æŠ˜å è¡Œæ•° */
        -webkit-box-orient: vertical;
        overflow: hidden;
        transition: all 0.3s ease;
        margin-bottom: 0.5rem;
    }
    .summary-content.expanded {
        -webkit-line-clamp: unset;
        display: block;
    }
    .btn-expand {
        padding: 0;
        font-size: 0.875rem;
    }
</style>

<script>
function toggleSummary(button) {
    const container = button.previousElementSibling;
    const isExpanded = container.classList.contains('expanded');
    
    container.classList.toggle('expanded');
    button.textContent = isExpanded ? 'å±•å¼€' : 'æ”¶èµ·';
    
    // æ·»åŠ å¹³æ»‘æ»šåŠ¨
    if (!isExpanded) {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–tooltip
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl)
    })
})
</script>